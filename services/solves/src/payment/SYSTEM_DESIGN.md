# 결제 시스템 설계 (Payment System Design)

## 시스템 개요

AI Chatbot 서비스의 결제 시스템은 **크레딧 기반**으로 동작하며, **구독은 자동 충전 매니저** 역할을 합니다.

```
┌─────────────────────────────────────────────────────────────┐
│                      Payment System                          │
│                                                               │
│  ┌──────────────────┐         ┌──────────────────┐          │
│  │   Core System    │         │  Subscription    │          │
│  │   (크레딧 관리)   │ ◀─────  │   (자동 충전)    │          │
│  └──────────────────┘         └──────────────────┘          │
│         항상 사용                    선택사항                 │
└─────────────────────────────────────────────────────────────┘
```

## 아키텍처 다이어그램

### 1. Core System (크레딧 시스템)

```
┌─────────────┐
│    User     │
└──────┬──────┘
       │ 1:1
       ▼
┌─────────────────┐
│  CreditWallet   │  ← 크레딧 저장소 (단일 진실 공급원)
│  - balance      │
│  - version      │
└────────┬────────┘
         │
    ┌────┴────┬──────────┬──────────┐
    │         │          │          │
    ▼         ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ Ledger │ │ Usage  │ │Invoice │ │Refill  │
│ (원장)  │ │ Events │ │        │ │History │
└────────┘ └────────┘ └────────┘ └────────┘
```

### 2. Subscription Plugin (구독 시스템)

```
┌──────────────────┐
│ SubscriptionPlan │  ← 충전 규칙 정의
│  - monthlyQuota  │
│  - refillAmount  │
│  - rolloverEnabled │
└────────┬─────────┘
         │ N:1
         ▼
┌───────────────────┐
│ UserSubscription  │  ← 구독 상태 관리
│  - walletId ──────┼───┐
│  - currentPeriod  │   │
│  - lastRefillAt   │   │
└───────────────────┘   │
                        │ 1:1
                        ▼
                  ┌─────────────┐
                  │CreditWallet │  ← 같은 지갑 사용!
                  └─────────────┘
```

## 사용 플로우

### 시나리오 1: 구독 시작

```
사용자: "Pro 플랜 구독"
   │
   ▼
┌──────────────────────────────────────────┐
│ 1. subscriptionService.createSubscription│
├──────────────────────────────────────────┤
│  a) CreditWallet 생성                    │
│  b) UserSubscription 생성                │
│  c) 초기 크레딧 지급 (monthlyQuota)      │
│  d) CreditLedger 기록                    │
│     kind: "subscription_grant"           │
└──────────────────────────────────────────┘
   │
   ▼
결과: 지갑에 10,000 크레딧 충전 완료
```

### 시나리오 2: API 사용 (정상)

```
사용자: "GPT-4o 호출"
   │
   ▼
┌──────────────────────────────────────────┐
│ 1. API 요청 (프론트엔드/백엔드)          │
└──────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────┐
│ 2. 잔액 확인                             │
│    paymentService.getBalance(walletId)   │
│    → 9,500 크레딧                        │
└──────────────────────────────────────────┘
   │ 충분함
   ▼
┌──────────────────────────────────────────┐
│ 3. 사용량 계산 & 차감                     │
│    paymentService.deductCredit({         │
│      inputTokens, outputTokens, ...      │
│    })                                    │
│    → 150 크레딧 차감                     │
└──────────────────────────────────────────┘
   │
   ▼
결과: 성공 (잔액 9,350)
```

### 시나리오 3: 크레딧 소진 (자동 리필 가능)

```
사용자: "API 호출" (잔액: 50 크레딧)
   │
   ▼
┌──────────────────────────────────────────┐
│ 1. 잔액 확인                             │
│    balance: 50 < required: 150           │
└──────────────────────────────────────────┘
   │ 부족함!
   ▼
┌──────────────────────────────────────────┐
│ 2. 구독 확인                             │
│    subscriptionService.getActiveSubscription│
│    → Pro 플랜 구독 중                    │
└──────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────┐
│ 3. 자동 리필 체크                        │
│    subscriptionService.checkAndRefillCredits│
├──────────────────────────────────────────┤
│  a) 마지막 충전: 7시간 전               │
│  b) 충전 간격: 6시간 (OK!)              │
│  c) 현재 잔액: 50 < 최대: 2,000 (OK!)   │
│  d) 500 크레딧 자동 충전                │
│  e) lastRefillAt 업데이트               │
└──────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────┐
│ 4. 재시도: 크레딧 차감                   │
│    balance: 550 → 성공!                  │
└──────────────────────────────────────────┘
   │
   ▼
결과: 성공 (자동 충전됨, 잔액 400)
```

### 시나리오 4: 크레딧 소진 (리필 대기 중)

```
사용자: "API 호출" (잔액: 30 크레딧)
   │
   ▼
┌──────────────────────────────────────────┐
│ 1. 잔액 확인                             │
│    balance: 30 < required: 150           │
└──────────────────────────────────────────┘
   │ 부족함!
   ▼
┌──────────────────────────────────────────┐
│ 2. 구독 확인                             │
│    → Pro 플랜 구독 중                    │
└──────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────┐
│ 3. 자동 리필 체크                        │
│    subscriptionService.checkAndRefillCredits│
├──────────────────────────────────────────┤
│  a) 마지막 충전: 2시간 전               │
│  b) 충전 간격: 6시간 (아직 안됨!)       │
│  c) 다음 충전 시각: 4시간 후            │
│     → 2024-12-25 14:00                  │
└──────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────┐
│ 4. 에러 응답                             │
│    {                                     │
│      code: "INSUFFICIENT_CREDITS",       │
│      message: "크레딧 부족",             │
│      balance: "30",                      │
│      required: "150",                    │
│      nextRefillAt: "2024-12-25T14:00Z",  │
│      refillAmount: "500"                 │
│    }                                     │
└──────────────────────────────────────────┘
   │
   ▼
사용자: "4시간 후 14:00부터 다시 사용 가능합니다" 알림
```

### 시나리오 5: 월간 갱신

```
크론잡 (매일 자정 실행)
   │
   ▼
┌──────────────────────────────────────────┐
│ 1. 갱신 필요한 구독 조회                 │
│    WHERE currentPeriodEnd <= NOW()       │
└──────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────┐
│ 2. subscriptionService.renewSubscription │
├──────────────────────────────────────────┤
│  IF rolloverEnabled == true:             │
│    현재 잔액: 3,500                      │
│    + monthlyQuota: 10,000                │
│    = 새 잔액: 13,500 (누적!)            │
│                                          │
│  IF rolloverEnabled == false:            │
│    현재 잔액: 800 → 리셋 (소멸)         │
│    새 잔액: 1,000 (새로 시작)           │
└──────────────────────────────────────────┘
   │
   ▼
결과: 다음 달 크레딧 지급 완료
```

## 트리거 포인트

### 1. 사용자 요청 시 (실시간)

```typescript
// API 엔드포인트에서
try {
  // 1) 크레딧 차감 시도
  const usage = await paymentService.deductCredit({ ... });
  return { success: true, usage };

} catch (error) {
  if (error.message === "크레딧이 부족합니다") {

    // 2) 자동 리필 시도
    const refill = await subscriptionService.checkAndRefillCredits(userId);

    if (refill.refilled) {
      // 2-1) 리필 성공 → 재시도
      const usage = await paymentService.deductCredit({ ... });
      return { success: true, usage, autoRefilled: true };
    } else {
      // 2-2) 리필 불가 → 명확한 에러
      return {
        error: "INSUFFICIENT_CREDITS",
        message: "크레딧이 부족합니다",
        currentBalance: await getBalance(walletId),
        nextRefillAt: refill.nextRefillAt,  // ← 중요!
        refillAmount: plan.refillAmount,
      };
    }
  }
  throw error;
}
```

### 2. 크론잡 (백그라운드)

```typescript
// 5분마다 실행
cron.schedule("*/5 * * * *", async () => {
  const activeUsers = await getActiveSubscribers();

  for (const userId of activeUsers) {
    // 사전 충전 (API 호출 전에 미리)
    await subscriptionService.checkAndRefillCredits(userId);
  }
});

// 매일 자정 실행
cron.schedule("0 0 * * *", async () => {
  // 월간 갱신
  await renewExpiredSubscriptions();

  // 만료 처리
  await subscriptionService.expireSubscriptions();
});
```

### 3. 웹훅 (결제 완료)

```typescript
// Stripe/Toss 웹훅
app.post("/webhooks/payment", async (req) => {
  const { userId, planId } = req.body;

  // 구독 시작 → 첫 충전
  await subscriptionService.createSubscription(userId, planId);

  // 또는 갱신 → 다음 달 충전
  await subscriptionService.renewSubscription(subscriptionId);
});
```

## 상태 다이어그램

### 구독 상태

```
        createSubscription()
              │
              ▼
        ┌──────────┐
        │  active  │ ◀─┐ (매월 갱신)
        └────┬─────┘   │
             │         │
     cancelSubscription()
             │         │
             ▼         │
        ┌──────────┐   │
        │ canceled │   │
        └────┬─────┘   │
             │         │
     currentPeriodEnd  │
             │         │
             ▼         │
        ┌──────────┐   │
        │ expired  │   │
        └──────────┘   │
                       │
        renewSubscription()
```

### 크레딧 생명주기

```
┌─────────────────┐
│  충전 (Grant)   │
│  - 구독 시작    │
│  - 월간 갱신    │
│  - 자동 리필    │
│  - 추가 구매    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  사용 (Debit)   │
│  - API 호출     │
│  - 토큰 소비    │
└────────┬────────┘
         │
         ▼
    ┌────┴────┐
    │ 잔액?   │
    └────┬────┘
         │
    ┌────┴────────────────┐
    │                     │
    ▼                     ▼
┌─────────┐         ┌──────────┐
│ 충분함  │         │  부족함  │
└─────────┘         └────┬─────┘
                         │
                    ┌────┴────┐
                    │ 구독?   │
                    └────┬────┘
                         │
                ┌────────┴────────┐
                │                 │
                ▼                 ▼
          ┌──────────┐      ┌──────────┐
          │ 구독 중  │      │ 미구독   │
          └────┬─────┘      └────┬─────┘
               │                 │
          ┌────┴────┐            │
          │ 리필?   │            ▼
          └────┬────┘      ┌──────────┐
               │           │  에러    │
        ┌──────┴──────┐    └──────────┘
        │             │
        ▼             ▼
   ┌────────┐   ┌──────────┐
   │ 리필됨 │   │ 대기 중  │
   │ → 성공 │   │ → 에러   │
   └────────┘   │+ 다음시각│
                └──────────┘
```

## 데이터 흐름

### 읽기 (조회)

```
프론트엔드
   │
   ▼
GET /api/balance
   │
   ▼
┌──────────────────────────┐
│ 1. 구독 조회 (캐시 10분) │
│    subscription: {        │
│      walletId, planId     │
│    }                      │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 2. 잔액 조회 (캐시 10분) │
│    wallet.balance         │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 3. 플랜 조회 (캐시 1시간)│
│    plan: {                │
│      refillAmount,        │
│      refillIntervalHours  │
│    }                      │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 4. 다음 리필 계산        │
│    lastRefill + interval  │
└────────┬─────────────────┘
         │
         ▼
응답: {
  balance: "9,350",
  planName: "Pro",
  nextRefillAt: "2024-12-25T14:00Z",
  nextRefillAmount: "500"
}
```

### 쓰기 (차감)

```
프론트엔드: "API 호출"
   │
   ▼
POST /api/chat
   │
   ▼
┌──────────────────────────┐
│ 1. 비용 계산             │
│    가격표 조회 (캐시)    │
│    tokens → credits      │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 2. 차감 시도 (낙관적 락) │
│    CreditWallet.version  │
└────────┬─────────────────┘
         │
    ┌────┴────┐
    │ 성공?   │
    └────┬────┘
         │
    ┌────┴─────────┐
    │              │
    ▼              ▼
  성공          실패 (부족)
    │              │
    │              ▼
    │     ┌────────────────┐
    │     │ 3. 자동 리필   │
    │     │    시도        │
    │     └───────┬────────┘
    │             │
    │        ┌────┴────┐
    │        │ 리필?   │
    │        └────┬────┘
    │             │
    │      ┌──────┴──────┐
    │      │             │
    │      ▼             ▼
    │    리필됨       리필 불가
    │      │             │
    │      ▼             ▼
    │   재시도         에러
    │      │       (+ nextRefillAt)
    │      │             │
    └──────┴─────────────┘
           │
           ▼
┌──────────────────────────┐
│ 4. 원장 기록             │
│    CreditLedger          │
│    kind: "debit"         │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 5. 사용 이벤트 기록      │
│    UsageEvents           │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 6. 캐시 무효화           │
│    wallet balance        │
└────────┬─────────────────┘
         │
         ▼
응답: {
  success: true,
  usageId: "...",
  remainingBalance: "9,200",
  autoRefilled: true  // (리필된 경우)
}
```

## 에러 처리

### 1. 크레딧 부족 (리필 대기)

```json
{
  "error": "INSUFFICIENT_CREDITS",
  "message": "크레딧이 부족합니다",
  "details": {
    "currentBalance": "30",
    "required": "150",
    "nextRefillAt": "2024-12-25T14:00:00Z",
    "nextRefillAmount": "500",
    "waitTime": "4시간"
  },
  "actions": [
    {
      "type": "wait",
      "message": "4시간 후 자동 충전됩니다"
    },
    {
      "type": "purchase",
      "message": "즉시 크레딧 구매",
      "url": "/purchase"
    }
  ]
}
```

### 2. 구독 없음

```json
{
  "error": "NO_SUBSCRIPTION",
  "message": "구독 플랜이 없습니다",
  "details": {
    "currentBalance": "0"
  },
  "actions": [
    {
      "type": "subscribe",
      "message": "구독하고 자동 충전 받기",
      "url": "/subscribe"
    },
    {
      "type": "purchase",
      "message": "크레딧 구매",
      "url": "/purchase"
    }
  ]
}
```

## 성능 최적화

### 캐싱 전략

```
┌─────────────────┬─────────┬────────────────┐
│ 데이터          │  TTL    │  이유          │
├─────────────────┼─────────┼────────────────┤
│ AI 가격표       │ 1시간   │ 거의 안 바뀜  │
│ 구독 플랜       │ 1시간   │ 거의 안 바뀜  │
│ 구독 정보       │ 10분    │ 가끔 바뀜     │
│ 지갑 잔액       │ 10분    │ 자주 바뀜     │
│ 멱등성 키       │ 24시간  │ 중복 방지     │
│ 리필 락         │ 1분     │ 동시성 제어   │
└─────────────────┴─────────┴────────────────┘
```

### 동시성 제어

```
┌─────────────────┬──────────────┬────────────────┐
│ 작업            │  락 방식     │  이유          │
├─────────────────┼──────────────┼────────────────┤
│ 크레딧 차감     │ 낙관적 락    │ 높은 동시성   │
│                 │ (version)    │                │
│ 정기 충전       │ 분산 락      │ 중복 방지     │
│                 │ (Redis)      │                │
│ 구독 갱신       │ 비관적 락    │ 충돌 거의 없음│
│                 │ (FOR UPDATE) │                │
└─────────────────┴──────────────┴────────────────┘
```

## 모니터링 포인트

### 1. 비즈니스 메트릭

```
- 구독 전환율 (무료 → 유료)
- 이탈률 (구독 취소)
- 평균 크레딧 사용량 (플랜별)
- 자동 리필 성공률
- 크레딧 부족 에러 빈도
```

### 2. 기술 메트릭

```
- API 응답 시간 (p50, p95, p99)
- 캐시 히트율
- 낙관적 락 충돌률
- 데이터베이스 트랜잭션 시간
- 크론잡 실행 시간
```

## 확장 고려사항

### 1. 팀/조직 지원

```
Organization
  ├─ Members (N명)
  └─ SharedWallet (공용 지갑)
       └─ Subscription (팀 플랜)
```

### 2. 다중 통화

```typescript
plan: {
  priceUsd: "100",
  priceKrw: "130000",  // 추가
  priceJpy: "15000"    // 추가
}
```

### 3. 사용량 기반 할인

```typescript
if (monthlyUsage > 1000000) {
  discount = 0.2; // 20% 할인
}
```

## 요약

### 핵심 원칙

1. **크레딧이 중심**: 모든 것은 크레딧으로 귀결
2. **구독은 플러그인**: 자동 충전 매니저일 뿐
3. **명확한 피드백**: 사용자에게 항상 다음 행동 알림
4. **트리거 다양화**: 실시간 + 크론잡 + 웹훅

### 사용자 경험

- ✅ 구독 시작 → 즉시 사용 가능
- ✅ 크레딧 소진 → 자동 충전 (투명)
- ✅ 충전 대기 → 명확한 시각 안내
- ✅ 추가 구매 → 즉시 반영

### 개발자 경험

- ✅ 기존 시스템 그대로 사용
- ✅ 구독 추가는 선택사항
- ✅ 명확한 에러 메시지
- ✅ 쉬운 확장성
