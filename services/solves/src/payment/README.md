# ğŸ’³ Payment System - ê²°ì œ ì‹œìŠ¤í…œ ê°€ì´ë“œ

> ë¹ ë¥¸ ì‘ë‹µ + ì•ˆì „í•œ ì¶©ì „ì„ ë™ì‹œì— ë‹¬ì„±í•œ í¬ë ˆë”§ ê¸°ë°˜ ê²°ì œ ì‹œìŠ¤í…œ

## ğŸ“– ëª©ì°¨

1. [í•µì‹¬ ê°œë…](#í•µì‹¬-ê°œë…)
2. [ì•„í‚¤í…ì²˜](#ì•„í‚¤í…ì²˜)
3. [í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨](#í”Œë¡œìš°-ë‹¤ì´ì–´ê·¸ë¨)
4. [ì½”ë“œ ê°€ì´ë“œ](#ì½”ë“œ-ê°€ì´ë“œ)
5. [API ì‚¬ìš©ë²•](#api-ì‚¬ìš©ë²•)

---

## ğŸ¯ í•µì‹¬ ê°œë…

### ë¹ ë¥¸ ì‘ë‹µ ì „ëµ

```
ì‚¬ìš©ì ìš”ì²­ â†’ ì¦‰ì‹œ ì‘ë‹µ (10ms) â†’ ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬
```

**ì™œ ë¹ ë¥¸ê°€?**

- ìºì‹œì—ì„œ ì”ì•¡ë§Œ í™•ì¸
- DB íŠ¸ëœì­ì…˜ ì—†ìŒ
- ì‹¤ì œ ì°¨ê°ì€ ë¹„ë™ê¸°

### ì•ˆì „í•œ ì¶©ì „ ì „ëµ

```
ì¶©ì „ ìš”ì²­ â†’ ë½ íšë“ â†’ ìˆœì°¨ ì²˜ë¦¬ â†’ ë½ í•´ì œ
```

**ì™œ ì•ˆì „í•œê°€?**

- ë¹„ê´€ì  ë½ (FOR UPDATE)
- ë¶„ì‚° ë½ (Redis)
- ë©±ë“±ì„± ë³´ì¥

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Entry Points                            â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ API Request â”‚  â”‚Payment Webhookâ”‚  â”‚  Cron Job   â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚          â”‚                 â”‚                 â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Services                              â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚ Credit Service   â”‚  â”‚ Wallet Service   â”‚                â”‚
â”‚   â”‚ (í¬ë ˆë”§ ì°¨ê°/ì¶©ì „)â”‚  â”‚   (ì§€ê°‘ ê´€ë¦¬)    â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚            â”‚                      â”‚                          â”‚
â”‚            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚            â”‚    â”‚                              â”‚             â”‚
â”‚            â–¼    â–¼                              â”‚             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚             â”‚
â”‚   â”‚Subscription Service â”‚                      â”‚             â”‚
â”‚   â”‚    (êµ¬ë… ê´€ë¦¬)       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                              â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚  Redis Cache     â”‚          â”‚   PostgreSQL     â”‚        â”‚
â”‚   â”‚   (ë¹ ë¥¸ ì¡°íšŒ)     â”‚          â”‚   (ì˜êµ¬ ì €ì¥)     â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### íŒŒì¼ êµ¬ì¡°

```
payment/
â”œâ”€â”€ ğŸ“ Core Services
â”‚   â”œâ”€â”€ credit.service.ts      â­ í¬ë ˆë”§ ì°¨ê°/ì¶©ì „
â”‚   â”œâ”€â”€ wallet.service.ts      ğŸ’¼ ì§€ê°‘ ìƒì„±/ì¡°íšŒ
â”‚   â””â”€â”€ subscription.service.ts ğŸ“… êµ¬ë… ê´€ë¦¬
â”‚
â”œâ”€â”€ ğŸ› ï¸ Utilities
â”‚   â””â”€â”€ utils.ts               ğŸ”§ ë©±ë“±ì„±/ë½/ê³„ì‚°
â”‚
â”œâ”€â”€ ğŸ“Š Schema & Types
â”‚   â”œâ”€â”€ schema.ts              ğŸ’¾ DB ìŠ¤í‚¤ë§ˆ
â”‚   â””â”€â”€ types.ts               ğŸ“ íƒ€ì… ì •ì˜
â”‚
â””â”€â”€ âš™ï¸ Configuration
    â””â”€â”€ cache-keys.ts          ğŸ”‘ ìºì‹œ í‚¤ ê´€ë¦¬
```

---

## ğŸ“Š í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

### 1ï¸âƒ£ API ì‚¬ìš© í”Œë¡œìš° (ë¹ ë¥¸ ì‘ë‹µ)

```
ğŸ‘¤ ì‚¬ìš©ì          ğŸŒ API          ğŸ“¦ Cache       âš™ï¸ Background      ğŸ’¾ Database
    â”‚                â”‚                â”‚                â”‚                â”‚
    â”‚â”€â”€â”€ AI ìš”ì²­ â”€â”€â”€â–¶â”‚                â”‚                â”‚                â”‚
    â”‚                â”‚                â”‚                â”‚                â”‚
    â”‚                â”‚â”€â”€ ì”ì•¡ ì¡°íšŒ â”€â”€â–¶â”‚                â”‚                â”‚
    â”‚                â”‚   (walletId)   â”‚                â”‚                â”‚
    â”‚                â”‚                â”‚                â”‚                â”‚
    â”‚                â”‚â—€â”€ balance: â”€â”€â”€â”€â”‚                â”‚                â”‚
    â”‚                â”‚   "1000"       â”‚                â”‚                â”‚
    â”‚                â”‚                â”‚                â”‚                â”‚
    â”‚                â”‚                â”‚                â”‚                â”‚
    â”‚  â”Œâ”€ balance > 0ì¸ ê²½ìš° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚                â”‚
    â”‚â—€â”€â”¤ âœ… ì¦‰ì‹œ ì‘ë‹µ â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚ (200 OK)    â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚ ~10ms ì†Œìš”  â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€ ë¹„ë™ê¸° ì°¨ê° ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚â”€â”€ íŠ¸ëœì­ì…˜ ì‹œì‘ â”€â”€â–¶â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚   1. FOR UPDATE  â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚   2. ì”ì•¡ ì°¨ê°    â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚   3. ì›ì¥ ê¸°ë¡    â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚   4. ì´ë²¤íŠ¸ ê¸°ë¡  â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚â—€â”€ íŠ¸ëœì­ì…˜ ì»¤ë°‹ â”€â”€â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚             â”‚                â”‚â—€â”€â”€ ìºì‹œ ë¬´íš¨í™” â”€â”€â”‚                â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
    â”‚                â”‚                â”‚                â”‚                â”‚
    â”‚  â”Œâ”€ balance = 0ì¸ ê²½ìš° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚                â”‚
    â”‚  â”‚             â”‚                â”‚                â”‚                â”‚
    â”‚â—€â”€â”¤ âŒ í¬ë ˆë”§ ë¶€ì¡±â”‚                â”‚                â”‚                â”‚
    â”‚  â”‚ (êµ¬ë… ì²´í¬)  â”‚                â”‚                â”‚                â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                â”‚
```

### 2ï¸âƒ£ ì¶©ì „ í”Œë¡œìš° (ìˆœì°¨ ì²˜ë¦¬)

```
ğŸ’³ PGì‚¬      ğŸ”” Webhook    âš™ï¸ Credit Service    ğŸ”’ DB Lock    ğŸ’¾ Database    ğŸ“¦ Cache
    â”‚             â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚â”€ ê²°ì œ ì™„ë£Œ â”€â–¶â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚             â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚             â”‚â”€creditPurchase()â”‚                 â”‚             â”‚             â”‚
    â”‚             â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚             â”‚                 â”‚â”€â”€â”€â”€ ë©±ë“±ì„± ì²´í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚             â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚             â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”Œâ”€ ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â—€â”€â”€ ê¸°ì¡´ ì‘ë‹µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚  â”‚          â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚â—€â”€ âœ… ì„±ê³µ â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚  (ì¤‘ë³µ ë°©ì§€)     â”‚                 â”‚             â”‚             â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”Œâ”€ ì²˜ìŒ ìš”ì²­ì¸ ê²½ìš° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚          â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€ FOR UPDATE ë½ â”€â–¶â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â—€â”€ ë½ íšë“ ì™„ë£Œ â”€â”€â”€â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ì”ì•¡ ì¦ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. ì›ì¥ ê¸°ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Invoice ìƒíƒœ â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŠ¸ëœì­ì…˜ ì»¤ë°‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€â”€ ë½ í•´ì œ â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ì”ì•¡ ìºì‹œ ê°±ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚  â”‚          â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. ë©±ë“±ì„± í‚¤ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚  â”‚          â”‚                 â”‚                 â”‚             â”‚             â”‚
    â”‚  â”‚          â”‚â—€â”€ âœ… ì¶©ì „ ì™„ë£Œ â”€â”€â”€â”€â”‚                 â”‚             â”‚             â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3ï¸âƒ£ ìë™ ë¦¬í•„ í”Œë¡œìš°

```
ğŸ‘¤ ì‚¬ìš©ì    ğŸŒ API    âš™ï¸ Subscription     ğŸ” ë¶„ì‚° ë½    ğŸ”’ DB Lock    ğŸ’¾ Database
    â”‚           â”‚           Service            â”‚             â”‚             â”‚
    â”‚           â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚â”€ API ìš”ì²­ â–¶â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚ (ì”ì•¡ 0)   â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚           â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚           â”‚â”€checkAndRefillCredits()â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚
    â”‚           â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚           â”‚              â”‚â”€ ë¶„ì‚° ë½ íšë“ â”€â–¶â”‚             â”‚             â”‚
    â”‚           â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”Œâ”€ ë½ íšë“ ì‹¤íŒ¨ (ì´ë¯¸ ì²˜ë¦¬ ì¤‘) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”‚             â”‚
    â”‚  â”‚        â”‚              â”‚â—€â”€ ì‹¤íŒ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
    â”‚  â”‚        â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚        â”‚â—€â”€ refilled: false â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚           â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”Œâ”€ ë½ íšë“ ì„±ê³µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚        â”‚              â”‚â—€â”€ ë½ íšë“ âœ… â”€â”€â”€â”‚             â”‚             â”‚
    â”‚  â”‚        â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚        â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ êµ¬ë… ì¡°íšŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚  â”‚        â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Period ì¡°íšŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚  â”‚        â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”Œâ”€ ë¦¬í•„ ê°€ëŠ¥í•œ ê²½ìš° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚ (ê°„ê²© ì²´í¬ âœ…)  â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚ (íšŸìˆ˜ ì²´í¬ âœ…)  â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€â”€â”€â”€â”€ FOR UPDATE ë½ íšë“ â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ì”ì•¡ ì¦ê°€ â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. ì›ì¥ ê¸°ë¡ â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. refillCount++ â”€â”€â”€â–¶â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€â”€â”€â”€â”€ ë½ í•´ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€ ë¶„ì‚° ë½ í•´ì œ â”€â–¶â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚â—€â”€ âœ… ë¦¬í•„ ì„±ê³µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚â—€â”€ ìš”ì²­ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”‚        â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”Œâ”€ ë¦¬í•„ ë¶ˆê°€ (6ì‹œê°„ ì•ˆë¨ ë˜ëŠ” íšŸìˆ˜ ì´ˆê³¼) â”             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚â”€ ë¶„ì‚° ë½ í•´ì œ â”€â–¶â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚â—€â”€ nextRefillAt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚     â”‚              â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â”‚â—€â”€ â° ëŒ€ê¸° ì•ˆë‚´ â”€â”€â”€â”€â”€â”€â”‚                â”‚             â”‚             â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4ï¸âƒ£ ì›”ê°„ ê°±ì‹  í”Œë¡œìš° (Cron)

```
â° Cron Job         âš™ï¸ Subscription Service          ğŸ’¾ Database
     â”‚                        â”‚                          â”‚
     â”‚â”€ renewSubscription() â”€â–¶â”‚                          â”‚
     â”‚                        â”‚                          â”‚
     â”‚                        â”‚â”€â”€ FOR UPDATE ë½ íšë“ â”€â”€â”€â”€â–¶â”‚
     â”‚                        â”‚â”€â”€ êµ¬ë… & í”Œëœ ì¡°íšŒ â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                        â”‚â”€â”€ í˜„ì¬ Period ì™„ë£Œ ì²˜ë¦¬ â”€â”€â–¶â”‚
     â”‚                        â”‚                          â”‚
     â”‚  â”Œâ”€ rolloverEnabled = true (ì´ì›” ê°€ëŠ¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚                    â”‚                          â”‚
     â”‚  â”‚                    â”‚ ê¸°ì¡´ ì”ì•¡ + ì›”ê°„ í¬ë ˆë”§   â”‚
     â”‚  â”‚                    â”‚                          â”‚
     â”‚  â”‚                    â”‚â”€â”€ 1. ì”ì•¡ ì¦ê°€ (ëˆ„ì ) â”€â”€â”€â–¶â”‚
     â”‚  â”‚                    â”‚â”€â”€ 2. ì›ì¥ ê¸°ë¡ (grant) â”€â”€â–¶â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                        â”‚                          â”‚
     â”‚  â”Œâ”€ rolloverEnabled = false (ì´ì›” ë¶ˆê°€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  â”‚                    â”‚                          â”‚
     â”‚  â”‚                    â”‚ ê¸°ì¡´ ì”ì•¡ ë¦¬ì…‹           â”‚
     â”‚  â”‚                    â”‚                          â”‚
     â”‚  â”‚                    â”‚â”€â”€ 1. ì”ì•¡ ë¦¬ì…‹ (reset) â”€â”€â–¶â”‚
     â”‚  â”‚                    â”‚â”€â”€ 2. ìƒˆ í¬ë ˆë”§ (grant) â”€â”€â–¶â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                        â”‚                          â”‚
     â”‚                        â”‚â”€â”€ 3. ìƒˆ Period ìƒì„± â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                        â”‚â”€â”€ 4. êµ¬ë… ê¸°ê°„ ì—°ì¥ â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                        â”‚â—€â”€ íŠ¸ëœì­ì…˜ ì»¤ë°‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚                          â”‚
     â”‚â—€â”€ âœ… ê°±ì‹  ì™„ë£Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
```

---

## ğŸ’¡ í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜

### ë©±ë“±ì„± ë³´ì¥

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ìš”ì²­   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ ìºì‹œ ì²´í¬  â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚
           [ìˆìŒ]                [ì—†ìŒ]
              â”‚                     â”‚
              â–¼                     â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ê¸°ì¡´ ì‘ë‹µ ë°˜í™˜ â”‚      â”‚ DB ì²˜ë¦¬  â”‚
      â”‚    (ì„±ê³µ)     â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                            â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                            â”‚           â”‚
                         [ì„±ê³µ]       [ì¤‘ë³µ]
                            â”‚           â”‚
                            â–¼           â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ìºì‹œ ì €ì¥ â”‚  â”‚DB ì¸ë±ìŠ¤   â”‚
                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚   ì—ëŸ¬     â”‚
                           â”‚        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â–¼              â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ì‘ë‹µ ë°˜í™˜ â”‚  â”‚ì—ëŸ¬ ì²˜ë¦¬ â”‚
                      â”‚ (ì„±ê³µ)   â”‚  â”‚  (ì‹¤íŒ¨)  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2ë‹¨ê³„ ë°©ì–´**

1. **ìºì‹œ ë ˆë²¨**: ë¹ ë¥¸ ì¤‘ë³µ ì²´í¬ (Redis/Memory)
2. **DB ë ˆë²¨**: ìµœì¢… ë³´ì¥ (`uniqueIndex(walletId, idempotencyKey)`)

### ë™ì‹œì„± ì œì–´

| ì‘ì—…        | ë½ ë°©ì‹                          | ì´ìœ                               |
| ----------- | -------------------------------- | --------------------------------- |
| í¬ë ˆë”§ ì°¨ê° | FOR UPDATE + ë‚™ê´€ì  ë½ (version) | ì¶©ì „ ëŒ€ê¸° + ì¶©ëŒ ê°ì§€, 3íšŒ ì¬ì‹œë„ |
| í¬ë ˆë”§ ì¶©ì „ | ë¹„ê´€ì  ë½ (FOR UPDATE)           | ì¶©ëŒ ê±°ì˜ ì—†ìŒ, í™•ì‹¤í•œ ë³´ì¥       |
| ìë™ ë¦¬í•„   | ë¶„ì‚° ë½ + ë¹„ê´€ì  ë½ (FOR UPDATE) | ì¤‘ë³µ ë°©ì§€ + ë°ì´í„° ì •í•©ì„±         |

**âš ï¸ ì¤‘ìš” ë³€ê²½ì‚¬í•­**

- ì°¨ê°ë„ FOR UPDATE ì‚¬ìš©: ì¶©ì „/ë¦¬í•„ ì¤‘ì¼ ë•Œ **ëŒ€ê¸°** í›„ ì²˜ë¦¬
- ì´ì „: ë‚™ê´€ì  ë½ë§Œ â†’ ì¶©ëŒ ì‹œ ì¬ì‹œë„
- í˜„ì¬: FOR UPDATEë¡œ ë½ ëŒ€ê¸° + versionìœ¼ë¡œ ì´ì¤‘ ë³´ì¥

### ìºì‹± ì „ëµ

```
ì½ê¸° í”Œë¡œìš°:                       ì“°ê¸° í”Œë¡œìš°:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ìš”ì²­   â”‚                       â”‚ì—…ë°ì´íŠ¸  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                 â”‚
     â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ìºì‹œ í™•ì¸  â”‚                     â”‚ DB ë³€ê²½  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚                                â”‚
  â”Œâ”€â”€â”€â”´â”€â”€â”€â”                            â–¼
  â”‚       â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 HIT     MISS                    â”‚ìºì‹œ ë¬´íš¨í™”  â”‚
  â”‚       â”‚                      â”‚  (ì¤‘ìš”!)    â”‚
  â–¼       â–¼                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ì¦‰ì‹œâ”‚ â”‚DB ì¡°íšŒ â”‚
â”‚ë°˜í™˜â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â”‚    â”‚     â”‚
â”‚    â”‚     â–¼
â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    â”‚ â”‚ìºì‹œì €ì¥â”‚
â”‚    â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â”‚    â”‚     â”‚
â”‚    â”‚     â–¼
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”˜  â”‚ë°˜í™˜â”‚
        â””â”€â”€â”€â”€â”˜
```

**ìºì‹œ TTL ì „ëµ**

- AI ê°€ê²©í‘œ: 1ì‹œê°„ (ê±°ì˜ ì•ˆ ë°”ë€œ)
- êµ¬ë… í”Œëœ: 1ì‹œê°„ (ê±°ì˜ ì•ˆ ë°”ë€œ)
- ì§€ê°‘ ì”ì•¡: 10ë¶„ (ìì£¼ ë°”ë€œ)
- ë©±ë“±ì„± í‚¤: 24ì‹œê°„ (ì¤‘ë³µ ë°©ì§€)

---

## ğŸ“ ì½”ë“œ ê°€ì´ë“œ

### ğŸ¯ ì½”ë“œ ì½ëŠ” ìˆœì„œ

#### **1ë‹¨ê³„: ê¸°ë³¸ ê°œë… ì´í•´** (15ë¶„)

```
1ï¸âƒ£ schema.ts (L17-170)
   â†’ ì§€ê°‘/ì›ì¥ í…Œì´ë¸” êµ¬ì¡° íŒŒì•…

2ï¸âƒ£ types.ts
   â†’ í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ í™•ì¸
   - DeductCreditAsyncResponse (ë°±ê·¸ë¼ìš´ë“œ ì‘ë‹µ)
   - Subscription, SubscriptionPeriod
```

#### **2ë‹¨ê³„: í•µì‹¬ ë¡œì§** (30ë¶„)

```
3ï¸âƒ£ utils.ts
   â”œâ”€â”€ IdempotencyKeys (ë©±ë“±ì„± í‚¤ ìƒì„±)
   â”œâ”€â”€ DistributedLock (ë¶„ì‚° ë½)
   â””â”€â”€ PriceCalculator (ê°€ê²© ê³„ì‚°)

4ï¸âƒ£ credit.service.ts â­ ê°€ì¥ ì¤‘ìš”!
   â”œâ”€â”€ deductCreditAsync() (L148-178)
   â”‚   â””â”€â”€ ë¹ ë¥¸ ì‘ë‹µì˜ í•µì‹¬
   â”œâ”€â”€ deductCreditSync() (L180-311)
   â”‚   â””â”€â”€ ì‹¤ì œ ì°¨ê° ë¡œì§
   â””â”€â”€ creditPurchase() (L313-401)
       â””â”€â”€ ì¶©ì „ ë¡œì§
```

#### **3ë‹¨ê³„: êµ¬ë… ì‹œìŠ¤í…œ** (30ë¶„)

```
5ï¸âƒ£ wallet.service.ts
   â””â”€â”€ ê°„ë‹¨í•œ CRUD (ìƒëµ ê°€ëŠ¥)

6ï¸âƒ£ subscription.service.ts
   â”œâ”€â”€ createSubscription() (L108-210)
   â”‚   â””â”€â”€ ì§€ê°‘ + êµ¬ë… + Period ìƒì„±
   â””â”€â”€ checkAndRefillCredits() (L212-372) â­
       â””â”€â”€ ìë™ ë¦¬í•„ í•µì‹¬ ë¡œì§
```

### ğŸ” ì£¼ìš” ì½”ë“œ í¬ì¸íŠ¸

#### **ë°±ê·¸ë¼ìš´ë“œ ì°¨ê° (credit.service.ts)**

```typescript
// L148-178: ë¹ ë¥¸ ì‘ë‹µ
deductCreditAsync: async (params) => {
  // 1. ë©±ë“±ì„± ì²´í¬ (ìºì‹œ)
  const cached = await cache.get(CacheKeys.idempotency(idempotencyKey));
  if (cached) return JSON.parse(cached);

  // 2. ì”ì•¡ ì²´í¬ (ìºì‹œ ìš°ì„ )
  const balance = await creditService.getBalance(walletId);
  if (Number(balance) <= 0) throw new Error("í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤");

  // 3. ì¦‰ì‹œ ì‘ë‹µ âœ…
  const estimatedBalance = balance;

  // 4. ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ (await ì—†ìŒ!)
  creditService
    .deductCreditSync(params) // âš ï¸ ë‚´ë¶€ì—ì„œ FOR UPDATE ë½ ì‚¬ìš©
    .then((result) => console.log("ì„±ê³µ:", result))
    .catch((error) => console.error("ì‹¤íŒ¨:", error));

  return { success: true, estimatedBalance };
};

// L204-214: ì‹¤ì œ ì°¨ê° ë¡œì§ (FOR UPDATE)
deductCreditSync: async (params) => {
  // ...
  // ì§€ê°‘ ì¡°íšŒ ì‹œ FOR UPDATE ë½ ì‚¬ìš©
  // â†’ ì¶©ì „/ë¦¬í•„ ì¤‘ì´ë©´ ëŒ€ê¸°í•¨ âœ…
  const wallet = await tx.execute(sql`
    SELECT * FROM credit_wallet WHERE id = ${walletId} FOR UPDATE
  `);

  // ë‚™ê´€ì  ë½ìœ¼ë¡œ ì¶©ëŒ ê°ì§€ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
  await tx
    .update(CreditWalletTable)
    .set({ balance, version: version + 1 })
    .where(and(eq(id, walletId), eq(version, currentVersion)));
  // ...
};
```

#### **ë¶„ì‚° ë½ + ë¹„ê´€ì  ë½ (subscription.service.ts)**

```typescript
// L212-372: ì•ˆì „í•œ ë¦¬í•„
checkAndRefillCredits: async (userId) => {
  // 1. ë¶„ì‚° ë½ íšë“ (ì¤‘ë³µ ë°©ì§€)
  const lock = new DistributedLock(CacheKeys.refillLock(userId));
  if (!await lock.acquire()) return { refilled: false };

  try {
    // 2. ì¡°ê±´ ì²´í¬
    const canRefill = /* ê°„ê²© & íšŸìˆ˜ ì²´í¬ */;
    if (!canRefill) return { refilled: false, nextRefillAt };

    // 3. DB íŠ¸ëœì­ì…˜ (ë¹„ê´€ì  ë½)
    await pgDb.transaction(async (tx) => {
      const wallet = await tx.execute(sql`
        SELECT * FROM credit_wallet WHERE id = ${walletId} FOR UPDATE
      `);

      // ì¶©ì „ ë¡œì§...
    });

    return { refilled: true, ... };
  } finally {
    await lock.release(); // ë°˜ë“œì‹œ í•´ì œ
  }
}
```

---

## ğŸš€ API ì‚¬ìš©ë²•

### 1. AI API í˜¸ì¶œ (ë°±ê·¸ë¼ìš´ë“œ ì°¨ê°)

```typescript
import { creditService, walletService } from "@service/payment";

// ì‚¬ìš©ì ì§€ê°‘ ì¡°íšŒ
const wallet = await walletService.getOrCreateWallet(userId);

// ë°±ê·¸ë¼ìš´ë“œ ì°¨ê° (ì¦‰ì‹œ ì‘ë‹µ!)
const result = await creditService.deductCreditAsync({
  walletId: wallet.id,
  userId,
  provider: "openai",
  model: "gpt-4o-mini",
  inputTokens: 1000,
  outputTokens: 500,
  cachedTokens: 0,
  idempotencyKey: `chat:${messageId}`, // ì™¸ë¶€ì—ì„œ í‚¤ ìƒì„±
});

console.log("ì¦‰ì‹œ ì‘ë‹µ:", result.estimatedBalance);
// ì‹¤ì œ ì°¨ê°ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§„í–‰
```

### 2. í¬ë ˆë”§ ì¶©ì „ (ìˆœì°¨ ì²˜ë¦¬)

```typescript
import { creditService } from "@service/payment";

// ì›¹í›… í•¸ë“¤ëŸ¬
app.post("/webhooks/payment", async (req, res) => {
  const { walletId, userId, amount, invoiceId } = req.body;

  const result = await creditService.creditPurchase({
    walletId,
    userId,
    creditAmount: amount,
    invoiceId,
    idempotencyKey: `credit:${invoiceId}`, // ì™¸ë¶€ì—ì„œ í‚¤ ìƒì„±
  });

  res.json({ success: true, newBalance: result.newBalance });
});
```

### 3. êµ¬ë… ìƒì„±

```typescript
import { subscriptionService } from "@service/payment";

// í”Œëœ IDëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì„ íƒ
const result = await subscriptionService.createSubscription(
  userId,
  planId // "plan_abc123..."
);

console.log(`êµ¬ë… ìƒì„±: ${result.initialCredits} í¬ë ˆë”§ ì§€ê¸‰`);
```

### 4. ìë™ ë¦¬í•„ ì²´í¬

```typescript
import { subscriptionService } from "@service/payment";

// ì”ì•¡ ë¶€ì¡± ì‹œ
const result = await subscriptionService.checkAndRefillCredits(userId);

if (result.refilled) {
  console.log(`ë¦¬í•„ ì„±ê³µ: ${result.refillAmount} í¬ë ˆë”§`);
} else if (result.nextRefillAt) {
  console.log(`ë‹¤ìŒ ë¦¬í•„: ${result.nextRefillAt}`);
} else {
  console.log("ë¦¬í•„ ë¶ˆê°€ (êµ¬ë… ì—†ìŒ ë˜ëŠ” íšŸìˆ˜ ì´ˆê³¼)");
}
```

---

## âš™ï¸ í™˜ê²½ ì„¤ì •

### í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜

```bash
# Redis (ìºì‹œ & ë¶„ì‚° ë½)
REDIS_URL=redis://localhost:6379

# PostgreSQL
DATABASE_URL=postgresql://user:pass@localhost:5432/db
```

### ìºì‹œ ì„¤ì •

```typescript
// forceMemory: true â†’ ê°œë°œ í™˜ê²½ (Redis ì—†ì´ ë©”ëª¨ë¦¬ ì‚¬ìš©)
const cache = createCache({ forceMemory: true });

// forceMemory: false â†’ í”„ë¡œë•ì…˜ (Redis ì‚¬ìš©)
const cache = createCache({ forceMemory: false });
```

---

## ğŸ“ˆ ì„±ëŠ¥ ì§€í‘œ

### ì‘ë‹µ ì†ë„ ë¹„êµ

| ì‘ì—…            | ê¸°ì¡´   | ê°œì„    | ë°°ìœ¨               |
| --------------- | ------ | ------ | ------------------ |
| API í˜¸ì¶œ (ì°¨ê°) | ~200ms | ~10ms  | **20ë°° í–¥ìƒ**      |
| í¬ë ˆë”§ ì¡°íšŒ     | ~50ms  | ~2ms   | 25ë°° í–¥ìƒ          |
| ì¶©ì „            | ~100ms | ~100ms | ë™ì¼ (ì•ˆì „ì„± ìš°ì„ ) |

### ë™ì‹œì„± ì²˜ë¦¬

- **ë‚™ê´€ì  ë½**: 100+ ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥
- **ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜**: ìµœëŒ€ 3íšŒ, 100ms ê°„ê²©
- **ì‹¤íŒ¨ìœ¨**: < 0.1% (ì¶©ëŒ ì‹œ ì¬ì‹œë„ë¡œ í•´ê²°)

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Q. ë°±ê·¸ë¼ìš´ë“œ ì°¨ê°ì´ ì‹¤íŒ¨í•˜ë©´?

**A.** ë¡œê·¸ì— ê¸°ë¡ë˜ê³ , ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì— ì•Œë¦¼

- ì‚¬ìš©ìëŠ” ì´ë¯¸ ì‘ë‹µì„ ë°›ì•˜ìœ¼ë¯€ë¡œ UX ì˜í–¥ ì—†ìŒ
- ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì¬ì‹œë„ íë¡œ ì´ë™

### Q. ë¦¬í•„ì´ ì¤‘ë³µë˜ë©´?

**A.** ë¶„ì‚° ë½ìœ¼ë¡œ ì›ì²œ ì°¨ë‹¨

- ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ì™€ë„ 1ê°œë§Œ ì²˜ë¦¬
- `refillCount`ë¡œ ì›”ê°„ íšŸìˆ˜ ì œí•œ

### Q. ë©±ë“±ì„± í‚¤ëŠ” ì–¸ì œ ìƒì„±í•˜ë‚˜?

**A.** ì™¸ë¶€ì—ì„œ ìƒì„±í•´ì„œ ì „ë‹¬

```typescript
// âŒ ì„œë¹„ìŠ¤ ë‚´ë¶€ì—ì„œ ìƒì„± X (ì œê±°í•¨)
IdempotencyKeys.forDebit(walletId, requestId)

// âœ… ì™¸ë¶€ì—ì„œ ìƒì„±í•´ì„œ ì „ë‹¬
const idempotencyKey = `chat:${messageId}`;
creditService.deductCreditAsync({ ..., idempotencyKey });
```

---

## ğŸ“ ë” ì•Œì•„ë³´ê¸°

### ê´€ë ¨ ë¬¸ì„œ

- [Schema ê°€ì´ë“œ](./schema.ts) - DB í…Œì´ë¸” êµ¬ì¡°
- [Types ê°€ì´ë“œ](./types.ts) - íƒ€ì… ì •ì˜
- [ì‹œìŠ¤í…œ ì„¤ê³„](./SYSTEM_DESIGN.md) - ìƒì„¸ ì„¤ê³„ ë¬¸ì„œ

### ë‹¤ìŒ ë‹¨ê³„

1. **í…ŒìŠ¤íŠ¸ ì‘ì„±**

   - ë™ì‹œì„± í…ŒìŠ¤íŠ¸ (100ê°œ ë™ì‹œ ìš”ì²­)
   - ë©±ë“±ì„± í…ŒìŠ¤íŠ¸ (ì¤‘ë³µ ìš”ì²­)
   - ë¦¬í•„ ë¡œì§ í…ŒìŠ¤íŠ¸

2. **ëª¨ë‹ˆí„°ë§ ì„¤ì •**

   - ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì‹¤íŒ¨ìœ¨
   - ìºì‹œ íˆíŠ¸ìœ¨
   - ë½ ëŒ€ê¸° ì‹œê°„

3. **í”„ë¡œë•ì…˜ ì¤€ë¹„**
   - Redis í ì ìš© (Bull/BullMQ)
   - Dead Letter Queue êµ¬ì„±
   - ì•Œë¦¼ ì‹œìŠ¤í…œ ì—°ë™

---

## ğŸ‘¥ ê¸°ì—¬ì

ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!

**Happy Coding! ğŸš€**
