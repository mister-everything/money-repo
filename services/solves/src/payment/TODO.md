# Payment Module - TODO

## 🚀 Production 배포 전 필수 작업

### 1. 환경 설정

- [ ] **Redis 설정**: Production 환경에서 `REDIS_URL` 환경변수 설정
- [ ] **환경변수 검증**: `NODE_ENV=production`에서 Redis 없으면 서비스 시작 실패 확인
- [ ] **캐시 테스트**: Redis 연결 및 분산 락 동작 확인

### 2. Cron Job 구현

- [ ] **구독 갱신 Cron**: 매월 1일 자정에 `renewSubscription()` 실행
- [ ] **만료 구독 처리 Cron**: 매일 자정에 `expireSubscriptions()` 실행
- [ ] **Cron 모니터링**: 실패 시 알림 시스템 연동

### 3. 모니터링 & 알림

- [ ] **백그라운드 차감 실패 알림**: `deductCreditSync` 실패 시 Slack/이메일 알림
- [ ] **Redis 연결 상태 모니터링**: Redis 다운 시 즉시 알림
- [ ] **잔액 이상 모니터링**: 음수 잔액 또는 비정상적 변동 감지

### 4. 테스트 작성

- [ ] **동시성 테스트**: 100개 동시 요청으로 race condition 테스트
- [ ] **멱등성 테스트**: 동일 요청 중복 처리 방지 확인
- [ ] **분산 락 테스트**: 여러 인스턴스에서 동시 리필 방지 확인
- [ ] **Redis 장애 테스트**: Redis 다운 시 서비스 동작 확인

## 🔧 선택적 개선사항

### 5. 성능 최적화

- [ ] **Redis Queue 도입**: 백그라운드 차감을 Bull/BullMQ로 전환
- [ ] **캐시 전략 개선**: Write-Through vs Write-Behind 검토
- [ ] **DB 인덱스 최적화**: 자주 사용되는 쿼리 성능 분석

### 6. 보안 강화

- [ ] **Rate Limiting**: API 요청 횟수 제한 (특히 `deductCreditAsync`)
- [ ] **잔액 검증 강화**: 백그라운드 차감 전 DB 재확인 로직
- [ ] **감사 로그**: 모든 크레딧 변동 상세 기록

### 7. 운영 도구

- [ ] **관리자 대시보드**: 구독/크레딧 현황 조회
- [ ] **수동 조정 도구**: 크레딧 수동 지급/차감 기능
- [ ] **리포팅**: 월별 매출, 사용량 통계

## 📋 장기 계획

### 8. 아키텍처 개선

- [ ] **Redlock 도입**: 더 안전한 분산 락 구현
- [ ] **Dead Letter Queue**: 실패한 백그라운드 작업 재처리
- [ ] **Circuit Breaker**: Redis 장애 시 자동 복구

### 9. 확장성

- [ ] **다중 리전 지원**: Redis 클러스터 구성
- [ ] **캐시 분할**: 지갑별 캐시 전략 세분화
- [ ] **마이크로서비스 분리**: 결제 모듈 독립 배포

---

## ⚠️ 중요 참고사항

1. **Redis 필수**: Production에서는 반드시 Redis 사용
2. **멀티 인스턴스 안전**: Vercel 서버리스 환경 고려
3. **모니터링 필수**: 백그라운드 작업 실패 감지 중요
4. **테스트 우선**: 동시성 테스트 반드시 수행

현재 코드는 보안 검토를 완료했지만, 실제 운영을 위해서는 위 작업들이 필요합니다.
